<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SONTAK SYSTEM V7.1</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --theme-color: #be00ff;
            --flex-color: #00d2ff;
            --mand-color: #ff9500;
            --bg-dark: #050505;
            --text-main: #fff;
            --success: #00ff9d;
            --danger: #ff4444;
            --gold-color: #ffd700;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: black;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            height: 100vh; 
            overflow: hidden; 
            position: relative;
        }

        /* FUNDO */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('./Fundo.jpg.jpg');
            background-size: cover; background-position: center; 
            opacity: 0.45; z-index: -2; filter: grayscale(20%);
        }

        /* CONTAINER PRINCIPAL */
        .app-container {
            width: 100%; max-width: 420px; height: 100%;
            background: rgba(5, 5, 10, 0.95);
            display: none; 
            flex-direction: column;
            position: relative;
            border-left: 1px solid #333; border-right: 1px solid #333;
        }

        /* --- HEADER --- */
        .header-container {
            flex-shrink: 0;
            background: rgba(0,0,0,0.9);
            border-bottom: 1px solid var(--theme-color);
            padding-bottom: 10px;
            z-index: 10;
        }
        .header { padding: 15px 20px 5px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 24px; color: var(--theme-color); letter-spacing: 2px; }
        .lvl-number { font-size: 24px; color: var(--theme-color); font-weight: bold; }

        .music-controls { display: flex; justify-content: center; gap: 15px; margin-top: 5px; }
        .music-btn {
            background: #111; border: 1px solid #444; color: var(--flex-color);
            border-radius: 4px; padding: 5px 15px; font-family: 'Share Tech Mono'; font-size: 12px;
        }
        .music-btn:active { background: var(--flex-color); color: black; }

        /* --- ÁREA DE CONTEÚDO --- */
        .content-area {
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
            padding-bottom: 80px; 
        }

        /* --- LOGIN (AJUSTADO PARA 4 DÍGITOS) --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .pass-display {
            border: 2px solid var(--theme-color);
            height: 50px; 
            width: 220px; 
            margin-bottom: 30px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Share Tech Mono'; font-size: 28px; color: #fff;
            letter-spacing: 12px; 
            border-radius: 10px;
            white-space: nowrap; 
        }

        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .key-btn {
            background: #000; border: 2px solid var(--theme-color); color: #fff;
            width: 70px; height: 70px; border-radius: 50%;
            font-size: 22px; font-family: 'Share Tech Mono';
            display: flex; align-items: center; justify-content: center;
        }
        .key-btn:active { background: var(--theme-color); color: black; }
        .key-action { border-radius: 10px; font-size: 16px; }
        .key-clear { border-color: var(--danger); color: var(--danger); }
        .key-enter { border-color: var(--success); color: var(--success); }

        /* --- GRÁFICOS E UI --- */
        .chart-wrapper { height: 250px; width: 100%; margin-bottom: 20px; }
        
        .xp-box { margin-bottom: 20px; }
        .xp-bar-bg { width: 100%; height: 10px; background: #222; border: 1px solid #444; border-radius: 5px; }
        .xp-bar-fill { height: 100%; width: 0%; background: var(--theme-color); transition: width 0.3s; }

        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 20px; text-align: center; }
        .stat-item { background: #111; border: 1px solid #333; padding: 5px; border-radius: 5px; }
        .stat-label { font-size: 10px; color: #888; display: block; }
        .stat-value { font-size: 16px; color: var(--theme-color); font-weight: bold; }

        /* --- LISTAS (CORES DIFERENCIADAS) --- */
        .quest-card {
            background: #111; border-left: 3px solid #444; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        /* COR: ÚNICA (Roxo) */
        .quest-card.type-unique { border-color: var(--theme-color); background: rgba(190, 0, 255, 0.05); }
        /* COR: RECORRENTE (Azul) */
        .quest-card.type-flexible { border-color: var(--flex-color); background: rgba(0, 210, 255, 0.05); }
        /* COR: OBRIGATÓRIA (Laranja) */
        .quest-card.type-mandatory { border-color: var(--mand-color); background: rgba(255, 149, 0, 0.05); }
        
        .checkbox { width: 25px; height: 25px; border: 2px solid #666; margin-right: 15px; display: grid; place-items: center; }
        .task-text { color: white; font-size: 16px; flex: 1; }
        .xp-tag { font-size: 12px; color: var(--success); font-weight: bold; }

        /* --- BIBLIOTECA --- */
        .library-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-bottom: 20px; }
        .book-card {
            background: #151515; border: 1px solid #333; border-radius: 5px; overflow: hidden;
            text-align: center; position: relative; min-height: 140px; cursor: pointer;
        }
        .book-cover { width: 100%; height: 140px; object-fit: cover; }
        .book-title-overlay {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8);
            color: white; font-size: 10px; padding: 5px;
        }
        
        /* --- EDITOR --- */
        .editor-box { background: #111; padding: 15px; border: 1px solid #333; margin-bottom: 20px; border-radius: 8px; }
        .sys-input, .sys-select { 
            width: 100%; background: #000; border: 1px solid #444; color: white; padding: 12px; margin-bottom: 10px; 
        }
        .btn-add { 
            width: 100%; background: var(--theme-color); color: black; border: none; padding: 15px; font-weight: bold; margin-top: 10px; 
        }
        
        .attr-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 10px; }
        .attr-btn { background: #222; border: 1px solid #444; color: #888; padding: 10px 0; text-align: center; font-size: 11px; }
        .attr-btn.selected { color: white; border-color: white; background: var(--theme-color); } 

        .recurrence-selector { display: flex; gap: 5px; margin-bottom: 15px; }
        .rec-btn { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 10px; font-size: 11px; }
        .rec-btn.active-rec { background: var(--flex-color); color: black; } 

        /* --- BOTÕES DE AÇÃO NA LISTA --- */
        .action-container { display: flex; gap: 10px; }
        .action-btn { background: none; border: none; font-size: 18px; cursor: pointer; }
        .btn-clone { color: var(--success); }
        .btn-del { color: var(--danger); }

        /* --- MENU INFERIOR (MELHORADO) --- */
        .bottom-nav {
            height: 60px; background: #0a0a0a; border-top: 1px solid #333;
            display: flex; 
            justify-content: space-between; /* Distribui */
            align-items: stretch; /* Estica altura */
            flex-shrink: 0; z-index: 50;
        }
        .nav-btn { 
            background: none; 
            border: none; 
            color: #555; 
            font-weight: bold; 
            font-size: 12px;
            flex: 1; /* Ocupa espaço igual */
            height: 100%; /* Área clicável total */
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-direction: column;
        }
        .nav-btn.active { color: var(--theme-color); background: rgba(190, 0, 255, 0.05); }

        .tab-view { display: none; }
        .active-view { display: block; }

        /* BOOT */
        #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* NOTIFICAÇÃO E MODAIS */
        #notify { 
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--theme-color); color: black; padding: 10px 20px;
            font-weight: bold; border-radius: 20px; display: none; z-index: 100;
        }

        /* MODAL DE LIVRO */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 30000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #111; border: 2px solid var(--theme-color); padding: 20px;
            width: 85%; max-width: 350px; text-align: center; border-radius: 10px;
            box-shadow: 0 0 30px rgba(190,0,255,0.3);
        }
        .modal-img { width: 100%; max-width: 200px; border-radius: 5px; margin-bottom: 15px; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .btn-delete-book {
            background: #330000; color: #ff5555; border: 1px solid #ff5555;
            width: 100%; padding: 12px; font-weight: bold; margin-top: 15px;
        }
        .btn-close-modal {
            background: #222; color: #fff; border: 1px solid #444;
            width: 100%; padding: 10px; margin-top: 10px;
        }

    </style>
</head>
<body>

<audio id="bgMusic" loop><source src="./music.mp3.mp3" type="audio/mpeg"></audio>

<div id="login-overlay">
    <div style="font-family:'Share Tech Mono'; color:var(--theme-color); font-size:24px; margin-bottom:10px;">SONTAK SECURITY</div>
    
    <div class="pass-display" id="passDisplay">_ _ _ _</div>
    
    <div class="keypad">
        <div class="key-btn" onclick="pk(1)">1</div><div class="key-btn" onclick="pk(2)">2</div><div class="key-btn" onclick="pk(3)">3</div>
        <div class="key-btn" onclick="pk(4)">4</div><div class="key-btn" onclick="pk(5)">5</div><div class="key-btn" onclick="pk(6)">6</div>
        <div class="key-btn" onclick="pk(7)">7</div><div class="key-btn" onclick="pk(8)">8</div><div class="key-btn" onclick="pk(9)">9</div>
        <div class="key-btn key-action key-clear" onclick="clp()">C</div>
        <div class="key-btn" onclick="pk(0)">0</div>
        <div class="key-btn key-action key-enter" onclick="chp()">OK</div>
    </div>
</div>

<div id="boot-screen">
    <div style="color:var(--success); font-family:'Share Tech Mono';">INITIALIZING SYSTEM...</div>
</div>

<div id="notify">SALVO!</div>

<div id="bookModal" class="modal-overlay" onclick="closeBookModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h3 id="modalBookTitle" style="color:var(--theme-color); margin-top:0;">TITULO</h3>
        <img id="modalBookCover" src="" class="modal-img">
        <div id="modalBookXp" style="color:#aaa; font-size:12px;">XP: 0</div>
        
        <button class="btn-delete-book" id="btnDeleteBook">EXCLUIR DO ACERVO</button>
        <button class="btn-close-modal" onclick="closeBookModal()">FECHAR</button>
    </div>
</div>

<div class="app-container" id="mainApp">
    
    <div class="header-container">
        <div class="header">
            <h1>SONTAK</h1>
            <div class="lvl-number">LVL <span id="displayLevel">1</span></div>
        </div>
        <div class="music-controls">
            <div class="music-btn" onclick="vol(-0.1)">VOL -</div>
            <div class="music-btn" onclick="mus()" id="btnMus">PLAY</div>
            <div class="music-btn" onclick="vol(0.1)">VOL +</div>
        </div>
    </div>

    <div class="content-area">

        <div id="tab-home" class="tab-view active-view">
            <div class="xp-box">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:5px;">
                    <span>XP ATUAL</span> <span id="xpText">0 / 100</span>
                </div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar"></div></div>
            </div>
            
            <div class="chart-wrapper"><canvas id="statsChart"></canvas></div>
            
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">FOR</span><span id="val-STR" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">AGI</span><span id="val-AGI" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">VIT</span><span id="val-VIT" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">INT</span><span id="val-INT" class="stat-value">0</span></div>
                <div class="stat-item"><span class="stat-label">SEN</span><span id="val-SEN" class="stat-value">0</span></div>
            </div>

            <div style="color:var(--theme-color); font-weight:bold; margin:20px 0 10px;">MISSÕES ATIVAS</div>
            <div id="home-quest-list"></div>
        </div>

        <div id="tab-library" class="tab-view">
            <div style="color:var(--theme-color); font-weight:bold; margin-bottom:10px;">BIBLIOTECA</div>
            
            <div class="editor-box">
                <input type="text" id="bTitle" class="sys-input" placeholder="Nome do Livro">
                <input type="text" id="bCover" class="sys-input" placeholder="Link da Imagem (Google)">
                <select id="bXp" class="sys-select">
                    <option value="0">0 XP (Apenas registrar)</option>
                    <option value="100">100 XP (Curto)</option>
                    <option value="200">200 XP (Médio)</option>
                    <option value="300">300 XP (Longo)</option>
                </select>
                <button class="btn-add" onclick="addBook()">ADICIONAR LIVRO</button>
            </div>

            <div id="library-grid" class="library-grid"></div>
        </div>

        <div id="tab-editor" class="tab-view">
            <div style="color:var(--theme-color); font-weight:bold; margin-bottom:10px;">NOVA MISSÃO</div>
            
            <div class="editor-box">
                <input type="text" id="qTitle" class="sys-input" placeholder="Descrição">
                
                <div style="font-size:12px; color:#888; margin-bottom:5px;">ATRIBUTOS:</div>
                <div class="attr-grid">
                    <div class="attr-btn" onclick="tgAttr('STR', this)">FOR</div>
                    <div class="attr-btn" onclick="tgAttr('AGI', this)">AGI</div>
                    <div class="attr-btn" onclick="tgAttr('VIT', this)">VIT</div>
                    <div class="attr-btn" onclick="tgAttr('INT', this)">INT</div>
                    <div class="attr-btn" onclick="tgAttr('SEN', this)">SEN</div>
                </div>

                <select id="qXp" class="sys-select">
                    <option value="50">50 XP</option>
                    <option value="100">100 XP</option>
                    <option value="200">200 XP</option>
                    <option value="500">500 XP</option>
                    <option value="1000">1000 XP</option>
                </select>

                <div class="recurrence-selector">
                    <div class="rec-btn" id="rec-none" onclick="setRec('none')">ÚNICA</div>
                    <div class="rec-btn" id="rec-flexible" onclick="setRec('flexible')">RECORRENTE</div>
                    <div class="rec-btn" id="rec-mandatory" onclick="setRec('mandatory')">OBRIGATÓRIA</div>
                </div>

                <button class="btn-add" onclick="addQuest()">CRIAR</button>
            </div>

            <div style="color:var(--theme-color); font-weight:bold; margin:20px 0 10px;">GERENCIAR</div>
            <div id="editor-quest-list"></div>
            
            <button onclick="resetAll()" style="background:#330000; color:red; border:1px solid red; width:100%; padding:10px; margin-top:30px;">RESETAR TUDO</button>
        </div>

    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="tab('home', this)">STATUS</button>
        <button class="nav-btn" onclick="tab('library', this)">GRIMÓRIO</button>
        <button class="nav-btn" onclick="tab('editor', this)">EDITOR</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnTgThcU_lVdXASbg9ufMeUEE_x2uaYfQ",
      authDomain: "sontak-arise.firebaseapp.com",
      databaseURL: "https://sontak-arise-default-rtdb.firebaseio.com",
      projectId: "sontak-arise",
      storageBucket: "sontak-arise.firebasestorage.app",
      messagingSenderId: "165204128476",
      appId: "1:165204128476:web:8ed10f60587bcecad47a19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const userRef = ref(db, 'usuarios/vitor');

    let data = { level: 1, xp: 0, stats: [0,0,0,0,0], quests: [], library: [] };
    let chart;
    let selAttrs = [];
    let selRec = 'none';
    let isPlay = false;
    const aud = document.getElementById('bgMusic');

    // --- AUDIO ---
    window.mus = () => {
        if(isPlay) { aud.pause(); document.getElementById('btnMus').innerText="PLAY"; }
        else { aud.play(); document.getElementById('btnMus').innerText="PAUSE"; }
        isPlay = !isPlay;
    }
    window.vol = (v) => {
        let n = aud.volume + v;
        if(n>1) n=1; if(n<0) n=0;
        aud.volume = n;
    }

    // --- LOGIN ---
    let p = "";
    window.pk = (n) => { if(p.length<4) { p+=n; uPass(); } }
    window.clp = () => { p=""; uPass(); }
    window.chp = () => {
        if(p==="0706") {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('boot-screen').style.display='flex';
            aud.volume=0.5; aud.play().then(()=>{isPlay=true; document.getElementById('btnMus').innerText="PAUSE";}).catch(()=>{});
            setTimeout(()=>{
                document.getElementById('boot-screen').style.display='none';
                document.getElementById('mainApp').style.display='flex';
                initApp();
            }, 2500);
        } else {
            p=""; uPass(); alert("SENHA INCORRETA");
        }
    }
    function uPass() {
        let s=""; for(let i=0;i<4;i++) s += (i<p.length) ? "● " : "_ ";
        document.getElementById('passDisplay').innerText = s;
    }

    // --- APP LOGIC ---
    function initApp() {
        initChart();
        onValue(userRef, (snap) => {
            const v = snap.val();
            if(v) {
                data = v;
                if(!data.quests) data.quests=[];
                if(!data.library) data.library=[];
                if(!data.stats) data.stats=[0,0,0,0,0];
            } else save();
            render();
        });
    }

    function save() { set(userRef, data); render(); }

    function render() {
        // XP
        let req = Math.min(data.level*100, 2500);
        document.getElementById('displayLevel').innerText = data.level;
        document.getElementById('xpText').innerText = `${data.xp} / ${req}`;
        document.getElementById('xpBar').style.width = Math.min((data.xp/req)*100, 100)+"%";

        // Stats
        const lbs = ['STR','AGI','VIT','INT','SEN'];
        const vData = [];
        data.stats.forEach((x, i) => {
            const l = Math.floor(Math.sqrt(x/100));
            document.getElementById(`val-${lbs[i]}`).innerText = l;
            vData.push(Math.min(l*5, 100));
        });
        chart.data.datasets[0].data = vData;
        chart.update();

        // Quests Home (CORES APLICADAS AQUI)
        const hl = document.getElementById('home-quest-list');
        hl.innerHTML = "";
        data.quests.forEach((q, i) => {
            if(!q.done) {
                let cl = "type-unique"; // Default
                if(q.rec==='flexible') cl = "type-flexible";
                if(q.rec==='mandatory') cl = "type-mandatory";
                
                hl.innerHTML += `
                <div class="quest-card ${cl}">
                    <div class="checkbox" onclick="doneQuest(${i})"></div>
                    <div class="task-text">${q.text}</div>
                    <div class="xp-tag">+${q.xp}</div>
                </div>`;
            }
        });

        // Quests Editor
        const el = document.getElementById('editor-quest-list');
        el.innerHTML = "";
        data.quests.forEach((q, i) => {
            el.innerHTML += `
            <div class="quest-card">
                <div class="task-text" style="color:#888">${q.text}</div>
                <div class="action-container">
                    <button class="action-btn btn-clone" onclick="cloneQuest(${i})">↺</button>
                    <button class="action-btn btn-del" onclick="delQuest(${i})">✖</button>
                </div>
            </div>`;
        });

        // Library
        const lib = document.getElementById('library-grid');
        lib.innerHTML = "";
        data.library.forEach((b, i) => {
            let img = b.cover || 'https://via.placeholder.com/100x140?text=S/Capa';
            lib.innerHTML += `
            <div class="book-card" onclick="openBookDetails(${i})">
                <img src="${img}" class="book-cover">
                <div class="book-title-overlay">${b.title}</div>
            </div>`;
        });
    }

    // --- ACTIONS ---
    window.doneQuest = (i) => {
        const q = data.quests[i];
        q.done = true;
        data.xp += q.xp;
        let share = Math.floor(q.xp / q.attrs.length);
        q.attrs.forEach(a => {
            let idx = ['STR','AGI','VIT','INT','SEN'].indexOf(a);
            if(idx>-1) data.stats[idx] += share;
        });
        let req = Math.min(data.level*100, 2500);
        while(data.xp >= req) { data.xp -= req; data.level++; req = Math.min(data.level*100, 2500); alert("LEVEL UP!"); }
        save(); notify("CONCLUÍDO!");
    }

    window.addQuest = () => {
        const t = document.getElementById('qTitle').value;
        const x = parseInt(document.getElementById('qXp').value);
        if(t && selAttrs.length>0) {
            data.quests.push({ text:t, xp:x, attrs:[...selAttrs], rec:selRec, done:false });
            save();
            document.getElementById('qTitle').value="";
            selAttrs=[]; selRec='none';
            document.querySelectorAll('.attr-btn').forEach(b=>b.classList.remove('selected'));
            document.querySelectorAll('.rec-btn').forEach(b=>b.classList.remove('active-rec'));
            notify("CRIADO!");
        } else alert("Preencha nome e atributos");
    }

    // NOVA FUNÇÃO DE CLONE
    window.cloneQuest = (i) => {
        const original = data.quests[i];
        data.quests.push({
            text: original.text,
            xp: original.xp,
            attrs: [...original.attrs],
            rec: original.rec,
            done: false
        });
        save();
        notify("TAREFA CLONADA!");
    }

    window.tgAttr = (a, el) => {
        if(selAttrs.includes(a)) { selAttrs = selAttrs.filter(x=>x!==a); el.classList.remove('selected'); }
        else { selAttrs.push(a); el.classList.add('selected'); }
    }

    window.setRec = (r) => {
        selRec = r;
        document.querySelectorAll('.rec-btn').forEach(b=>b.classList.remove('active-rec'));
        document.getElementById('rec-'+r).classList.add('active-rec');
    }

    window.delQuest = (i) => { if(confirm("Apagar?")) { data.quests.splice(i,1); save(); } }

    // --- BOOKS ---
    window.addBook = () => {
        const t = document.getElementById('bTitle').value;
        const c = document.getElementById('bCover').value;
        const x = parseInt(document.getElementById('bXp').value);
        
        if(t) {
            data.library.push({ title:t, cover:c, xpValue: x });
            if(x > 0) {
                data.xp += x;
                let share = Math.floor(x/2);
                data.stats[3]+=share; data.stats[4]+=share; // INT + SEN
                
                let req = Math.min(data.level*100, 2500);
                while(data.xp >= req) { data.xp -= req; data.level++; req = Math.min(data.level*100, 2500); alert("LEVEL UP!"); }
            }
            save();
            document.getElementById('bTitle').value="";
            document.getElementById('bCover').value="";
            notify("LIVRO ADD!");
        }
    }

    // Modal Details Logic
    window.openBookDetails = (i) => {
        const book = data.library[i];
        document.getElementById('modalBookTitle').innerText = book.title;
        document.getElementById('modalBookCover').src = book.cover || 'https://via.placeholder.com/100x140?text=S/Capa';
        document.getElementById('modalBookXp').innerText = `XP: ${book.xpValue || 0}`;
        
        document.getElementById('btnDeleteBook').onclick = () => {
            if(confirm("Remover este livro? (O XP ganho PERMANECE)")) {
                data.library.splice(i, 1);
                save();
                window.closeBookModal();
            }
        };
        
        document.getElementById('bookModal').style.display = 'flex';
    }

    window.closeBookModal = () => {
        document.getElementById('bookModal').style.display = 'none';
    }

    // --- TABS & CHART ---
    window.tab = (t, el) => {
        document.querySelectorAll('.tab-view').forEach(x=>x.style.display='none');
        document.getElementById('tab-'+t).style.display='block';
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        el.classList.add('active');
        if(t==='home' && chart) chart.resize();
    }

    function initChart() {
        const ctx = document.getElementById('statsChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['FOR', 'AGI', 'VIT', 'INT', 'SEN'],
                datasets: [{ data: [0,0,0,0,0], backgroundColor: 'rgba(190, 0, 255, 0.4)', borderColor: '#be00ff', borderWidth: 2, pointBackgroundColor: '#fff' }]
            },
            options: {
                scales: { r: { angleLines: { color: '#333' }, grid: { color: '#333' }, pointLabels: { color: '#fff' }, ticks: { display: false }, suggestedMin: 0, suggestedMax: 100 } },
                plugins: { legend: { display: false } }, maintainAspectRatio: false
            }
        });
    }

    window.resetAll = () => {
        if(prompt("SENHA ADM:")==="Yasuo010118*") {
            set(userRef, { level:1, xp:0, stats:[0,0,0,0,0], quests:[], library:[] });
            location.reload();
        }
    }

    function notify(msg) {
        const n = document.getElementById('notify');
        n.innerText = msg; n.style.display='block';
        setTimeout(()=>n.style.display='none', 2000);
    }

    // EXPOSE
    window.pk = window.pk; window.clp = window.clp; window.chp = window.chp;
    window.vol = window.vol; window.mus = window.mus;
    window.tab = window.tab; window.doneQuest = window.doneQuest;
    window.addQuest = window.addQuest; window.tgAttr = window.tgAttr;
    window.setRec = window.setRec; window.delQuest = window.delQuest;
    window.cloneQuest = window.cloneQuest;
    window.addBook = window.addBook; window.resetAll = window.resetAll;
    window.openBookDetails = window.openBookDetails; window.closeBookModal = window.closeBookModal;

</script>
</body>
</html>
