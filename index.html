<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM 2026-2027 - SONTAK EVOLUTION</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           1. VARIÁVEIS DE COR E RESET
           ========================================================================== */
        :root {
            /* Identidade Visual Sontak */
            --theme-color: #be00ff;   /* Roxo Neon Principal */
            --theme-glow: rgba(190, 0, 255, 0.5);
            
            --flex-color: #00d2ff;    /* Azul Ciano */
            --mand-color: #ff9500;    /* Laranja */
            
            --bg-dark: #050505;       /* Preto Fundo */
            --panel-bg: rgba(10, 10, 15, 0.95); /* Fundo dos Painéis */
            
            --text-main: #ffffff;
            
            /* Status */
            --success: #00ff9d;       /* Verde Hacker */
            --danger: #ff4444;        /* Vermelho Erro */
            --gold-color: #ffd700;    /* Level Up */
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: black;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            height: 100dvh; /* Garante tela cheia no mobile */
            overflow: hidden;
            user-select: none;
            position: relative;
            z-index: 1;
        }

        /* ==========================================================================
           2. FUNDO E EFEITOS VISUAIS
           ========================================================================== */
        
        /* Imagem de Fundo (Anime) */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('./Fundo.jpg.jpg'); /* Seu arquivo */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.45; /* Opacidade Solicitada */
            z-index: -2;
            filter: grayscale(10%) contrast(1.1);
        }

        /* Vinheta (Escurecer bordas) */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, black 100%);
            z-index: -1;
            pointer-events: none;
        }

        /* ==========================================================================
           3. ESTRUTURA DO APP
           ========================================================================== */
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            background: rgba(5, 5, 12, 0.92); /* Leve transparência para o fundo */
            border-left: 1px solid var(--theme-color);
            border-right: 1px solid var(--theme-color);
            box-shadow: 0 0 50px rgba(190, 0, 255, 0.15);
            display: none; /* Inicia oculto */
            flex-direction: column;
            position: relative;
            backdrop-filter: blur(8px);
            animation: appFadeIn 1s ease forwards;
        }

        @keyframes appFadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ==========================================================================
           4. CABEÇALHO E MÚSICA
           ========================================================================== */
        .header-container {
            flex-shrink: 0;
            border-bottom: 1px solid var(--theme-color);
            background: rgba(0, 0, 0, 0.8);
            z-index: 20;
            padding-bottom: 10px;
        }

        .header {
            padding: 15px 20px 5px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 26px;
            color: var(--theme-color);
            text-shadow: 0 0 10px var(--theme-color);
            letter-spacing: 2px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .lvl-badge {
            font-size: 12px;
            color: #aaa;
            text-align: right;
            font-family: 'Share Tech Mono';
        }

        .lvl-number {
            font-size: 28px;
            color: var(--theme-color);
            font-weight: bold;
        }

        /* Controles de Música */
        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 5px;
        }

        .music-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid #444;
            color: var(--flex-color);
            border-radius: 6px;
            padding: 6px 14px;
            cursor: pointer;
            font-family: 'Share Tech Mono';
            font-size: 11px;
            transition: all 0.2s;
            min-width: 40px;
        }

        .music-btn:active {
            background: var(--flex-color);
            color: black;
            box-shadow: 0 0 10px var(--flex-color);
        }

        .play-btn { width: 80px; text-align: center; }

        /* ==========================================================================
           5. ÁREA DE CONTEÚDO (SCROLL)
           ========================================================================== */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
            padding-bottom: 80px; /* Espaço para não cobrir com o menu */
        }

        /* Barra de XP */
        .xp-box { margin-bottom: 25px; }
        
        .xp-bar-bg {
            width: 100%;
            height: 12px;
            background: #222;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #444;
        }
        
        .xp-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--theme-color), #9900ff);
            transition: width 0.6s ease-out;
            box-shadow: 0 0 15px var(--theme-color);
        }

        /* Gráfico Radar */
        .chart-wrapper {
            position: relative;
            height: 280px;
            width: 100%;
            margin-bottom: 20px;
        }

        /* Grid de Atributos */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .stat-item {
            background: rgba(255,255,255,0.03);
            padding: 10px 2px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .stat-label {
            font-size: 10px;
            font-weight: bold;
            color: #888;
            display: block;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--theme-color);
            font-family: 'Share Tech Mono';
        }

        /* ==========================================================================
           6. BIBLIOTECA (LAYOUT ARRUMADO)
           ========================================================================== */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 Colunas Fixas */
            gap: 12px;
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .book-card {
            background: rgba(30, 30, 35, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            aspect-ratio: 2 / 3; /* Formato de livro padrão */
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }

        .book-card:active {
            transform: scale(0.95);
            border-color: var(--theme-color);
        }

        .book-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Placeholder se não tiver capa */
        .book-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            color: #666;
            font-size: 10px;
            text-align: center;
            padding: 5px;
            font-weight: bold;
        }

        /* Popup de Detalhes do Livro */
        .book-detail-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            text-align: left;
        }

        .book-expanded-cover {
            width: 140px;
            border-radius: 6px;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.1);
            border: 2px solid #333;
        }

        .book-xp-badge {
            background: var(--theme-color);
            color: black;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 0 10px var(--theme-color);
        }

        .book-synopsis {
            width: 100%;
            font-family: 'Segoe UI', sans-serif;
            font-size: 13px;
            color: #ccc;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        /* ==========================================================================
           7. FORMULÁRIOS E EDITOR
           ========================================================================== */
        .editor-box {
            background: rgba(16, 16, 22, 0.95);
            border: 1px solid #333;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .input-label {
            font-size: 11px;
            color: var(--theme-color);
            margin-bottom: 6px;
            display: block;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sys-input, .sys-select {
            width: 100%;
            background: #0a0a0a;
            border: 1px solid #444;
            color: white;
            padding: 14px;
            font-family: 'Rajdhani';
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            margin-bottom: 15px;
            border-radius: 6px;
            transition: 0.3s;
        }

        .sys-input:focus, .sys-select:focus {
            border-color: var(--theme-color);
            box-shadow: 0 0 15px rgba(190,0,255,0.2);
        }

        .btn-add {
            background: var(--theme-color);
            color: black;
            border: none;
            font-weight: 800;
            padding: 15px;
            width: 100%;
            cursor: pointer;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 6px;
            margin-top: 10px;
            box-shadow: 0 0 15px rgba(190,0,255,0.25);
            transition: transform 0.1s;
        }

        .btn-add:active { transform: scale(0.97); }

        .btn-reset {
            background: rgba(50, 0, 0, 0.5);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 12px;
            width: 100%;
            margin-top: 40px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
        }

        /* ==========================================================================
           8. LOGIN SCREEN (CORRIGIDO PARA O PRINT)
           ========================================================================== */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 2, 2, 0.95); /* Fundo quase preto para contraste */
            z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .login-title {
            font-family: 'Share Tech Mono';
            color: var(--theme-color);
            font-size: 28px;
            letter-spacing: 4px;
            margin-bottom: 10px;
            text-shadow: 0 0 20px var(--theme-color);
            text-transform: uppercase;
        }

        /* DISPLAY DE PONTOS (Estilo do print) */
        .pass-display {
            border: 2px solid var(--theme-color);
            background: transparent;
            height: 60px;
            width: 280px;
            border-radius: 10px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            letter-spacing: 15px;
            box-shadow: 0 0 15px rgba(190,0,255,0.2);
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px; /* Espaçamento do print */
        }

        /* BOTÃO DO TECLADO (Círculo Perfeito) */
        .key-btn {
            background-color: #000;
            border: 2px solid var(--theme-color);
            color: #fff;
            width: 75px;
            height: 75px; /* Tamanho fixo para ser redondo */
            font-size: 24px;
            font-family: 'Share Tech Mono';
            font-weight: bold;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(190, 0, 255, 0.3);
            transition: 0.1s;
        }

        .key-btn:active {
            background: var(--theme-color);
            color: #000;
            transform: scale(0.9);
        }

        /* Botão CLR (Vermelho) */
        .key-clear {
            border-color: var(--danger);
            color: var(--danger);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.3);
            border-radius: 15px; /* Quadrado arredondado como no print */
            font-size: 18px;
        }

        /* Botão ENT (Verde/Azul Neon) */
        .key-enter {
            border-color: var(--success);
            color: var(--success);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
            border-radius: 15px; /* Quadrado arredondado como no print */
            font-size: 18px;
        }

        /* Erro */
        .error-anim {
            animation: shake 0.3s;
            border-color: var(--danger) !important;
            color: var(--danger) !important;
        }

        /* ==========================================================================
           9. MENU INFERIOR
           ========================================================================== */
        .bottom-nav {
            height: 70px;
            background: rgba(0, 0, 0, 0.98);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            z-index: 50;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #555;
            font-family: 'Rajdhani';
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .nav-btn::before { content: "■"; font-size: 16px; }
        .nav-btn.active { color: var(--theme-color); text-shadow: 0 0 10px var(--theme-color); }

        /* ==========================================================================
           10. POPUPS
           ========================================================================== */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .popup-box { background: #0f0f12; border: 2px solid var(--theme-color); padding: 25px; text-align: center; box-shadow: 0 0 60px var(--theme-color); width: 85%; max-height: 80vh; overflow-y: auto; border-radius: 12px; }
        
        .levelup-box { background: #0f0f12; border: 2px solid var(--gold-color); padding: 40px 20px; text-align: center; box-shadow: 0 0 60px rgba(255, 215, 0, 0.5); width: 90%; border-radius: 12px; }
        .levelup-num { font-size: 90px; color: white; text-shadow: 0 0 30px var(--gold-color); font-weight: 800; animation: pulse 1s infinite; }

        .btn-close { background: #333; color: white; border: 1px solid #555; padding: 12px; width: 100%; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 14px; }
        .btn-delete { background: #3a1c1c; color: #ff5555; border: 1px solid #ff5555; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 6px; margin-top: 15px; }

        .section-title { color: var(--theme-color); border-left: 4px solid var(--theme-color); padding-left: 10px; margin: 25px 0 15px 0; font-size: 18px; font-weight: bold; text-transform: uppercase; }
        .tab-view { display: none; animation: fadeIn 0.3s; } .active-view { display: block; }
        
        /* Animações */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        @keyframes glitchFade { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 30px var(--theme-color); } 100% { opacity: 0.8; } }

        /* Quest Card Styles */
        .quest-card { background: linear-gradient(90deg, rgba(30,30,30,0.7) 0%, transparent 100%); border-left: 3px solid #444; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; border-radius: 0 6px 6px 0; }
        .checkbox { width: 24px; height: 24px; border: 2px solid #666; margin-right: 15px; cursor: pointer; display: grid; place-items: center; flex-shrink: 0; border-radius: 4px; }
        .task-text { color: white; font-size: 15px; flex: 1; }
        .tags-container { display: flex; flex-direction: column; align-items: flex-end; }
        .xp-tag { font-size: 11px; background: #111; padding: 2px 6px; border: 1px solid #333; color: var(--success); font-weight: bold; border-radius: 4px; }
        
        /* Boot Screen */
        #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; font-family: 'Share Tech Mono'; }
        .loader-line { width: 0%; height: 4px; background: var(--theme-color); box-shadow: 0 0 15px var(--theme-color); margin-top: 20px; animation: loadProgress 2.5s forwards; }
        @keyframes loadProgress { to { width: 80%; } }
        .fade-out-screen { opacity: 0; pointer-events: none; transition: opacity 0.8s ease-out; }
        
        /* Botões de Filtro/Atributo */
        .attr-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; }
        .attr-btn { background: #111; border: 1px solid #333; color: #666; padding: 10px 0; text-align: center; cursor: pointer; font-size: 11px; font-weight: bold; border-radius: 4px; }
        .attr-btn.selected { color: black; border-color: white; transform: scale(1.05); }
        .attr-btn[data-type="STR"].selected { background: #ff4444; } .attr-btn[data-type="AGI"].selected { background: #00d2ff; }
        .attr-btn[data-type="VIT"].selected { background: #00ff9d; } .attr-btn[data-type="INT"].selected { background: #be00ff; }
        .attr-btn[data-type="SEN"].selected { background: #ffd700; }
        
        .recurrence-selector { display: flex; gap: 5px; margin-bottom: 20px; }
        .rec-btn { flex: 1; background: #111; border: 1px solid #444; color: #888; padding: 10px; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .rec-btn.selected-none { background: #444; color: white; }
        .rec-btn.selected-flex { background: rgba(0,210,255,0.2); border-color: var(--flex-color); color: var(--flex-color); }
        .rec-btn.selected-mand { background: rgba(255,149,0,0.2); border-color: var(--mand-color); color: var(--mand-color); }
        
        .action-container { display: flex; gap: 10px; }
        .action-btn { background: none; border: none; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

<audio id="bgMusic" loop>
    <source src="./music.mp3.mp3" type="audio/mpeg">
</audio>

<div id="login-overlay">
    <div class="login-box">
        <div class="login-title">SONTAK SECURITY</div>
        <div style="color:#888; font-size:12px; margin-bottom:30px; letter-spacing:2px; font-family:'Rajdhani';">ACESSO RESTRITO - INSIRA CREDENCIAIS</div>
        
        <div class="pass-display" id="passDisplay">
            </div>

        <div class="keypad">
            <button class="key-btn" onclick="pressKey(1)">1</button>
            <button class="key-btn" onclick="pressKey(2)">2</button>
            <button class="key-btn" onclick="pressKey(3)">3</button>
            <button class="key-btn" onclick="pressKey(4)">4</button>
            <button class="key-btn" onclick="pressKey(5)">5</button>
            <button class="key-btn" onclick="pressKey(6)">6</button>
            <button class="key-btn" onclick="pressKey(7)">7</button>
            <button class="key-btn" onclick="pressKey(8)">8</button>
            <button class="key-btn" onclick="pressKey(9)">9</button>
            <button class="key-btn key-action key-clear" onclick="clearPass()">CLR</button>
            <button class="key-btn" onclick="pressKey(0)">0</button>
            <button class="key-btn key-action key-enter" onclick="checkPass()">ENT</button>
        </div>
    </div>
</div>

<div id="boot-screen">
    <div style="color:var(--flex-color); font-family:'Share Tech Mono'; margin-bottom:10px;">SYSTEM INITIALIZING...</div>
    <div style="color:var(--success); font-family:'Share Tech Mono'; margin-bottom:20px;">CONNECTING TO DATABASE...</div>
    <div class="loader-line"></div>
    <div style="margin-top:20px; font-size:24px; color:var(--theme-color); font-weight:bold; letter-spacing:3px;">BEM-VINDO, CAÇADOR</div>
</div>

<div class="app-container" id="mainApp">
    
    <div class="header-container">
        <div class="header">
            <div><h1 id="page-title">SONTAK</h1></div>
            <div class="lvl-badge">LEVEL <span class="lvl-number" id="displayLevel">1</span></div>
        </div>
        
        <div class="music-controls">
            <button class="music-btn" onclick="changeVolume(-0.1)">VOL -</button>
            <button class="music-btn play-btn" onclick="toggleMusic()" id="btnPlayPause">▶ PLAY</button>
            <button class="music-btn" onclick="changeVolume(0.1)">VOL +</button>
        </div>
    </div>

    <div class="content-area">

        <div id="tab-home" class="tab-view active-view">
            <div class="xp-box">
                <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px; color:#aaa;">
                    <span>XP ATUAL</span> <span id="xpText">0 / 100</span>
                </div>
                <div class="xp-bar-bg"><div class="xp-bar-fill" id="xpBar"></div></div>
            </div>

            <div class="chart-wrapper"><canvas id="statsChart"></canvas></div>
            
            <div class="stats-grid">
                <div class="stat-item"><span class="stat-label">FOR</span><span class="stat-value" id="val-STR">0</span></div>
                <div class="stat-item"><span class="stat-label">AGI</span><span class="stat-value" id="val-AGI">0</span></div>
                <div class="stat-item"><span class="stat-label">VIT</span><span class="stat-value" id="val-VIT">0</span></div>
                <div class="stat-item"><span class="stat-label">INT</span><span class="stat-value" id="val-INT">0</span></div>
                <div class="stat-item"><span class="stat-label">SEN</span><span class="stat-value" id="val-SEN">0</span></div>
            </div>

            <div class="section-title">MISSÕES PENDENTES</div>
            <div id="home-quest-list"></div>
        </div>

        <div id="tab-library" class="tab-view">
            <div class="section-title">GRIMÓRIOS ADQUIRIDOS</div>
            
            <div class="editor-box">
                <label class="input-label">REGISTRAR LIVRO (GOOGLE BOOKS API)</label>
                <input type="text" id="bookIsbn" class="sys-input" placeholder="ISBN (Ex: 9788535902778)">
                <div style="font-size:10px; color:#666; margin-top:-10px; margin-bottom:10px;">*Use ISBN para capa automática. Se falhar, use título manual.</div>
                
                <input type="text" id="bookTitleInput" class="sys-input" placeholder="Título Manual (Opcional)">
                
                <label class="input-label">RECOMPENSA</label>
                <select id="bookXp" class="sys-select">
                    <option value="0">0 XP (Já lido)</option>
                    <option value="100">100 XP (Curto)</option>
                    <option value="200">200 XP (Médio)</option>
                    <option value="300">300 XP (Épico)</option>
                </select>
                
                <button class="btn-add" id="btnAddBook" onclick="fetchAndAddBook()">BUSCAR E REGISTRAR</button>
            </div>

            <div id="library-grid" class="library-grid">
                </div>
        </div>

        <div id="tab-editor" class="tab-view">
            <div class="section-title">CRIAR NOVA MISSÃO</div>
            <div class="editor-box">
                <label class="input-label">NOME DA TAREFA</label>
                <input type="text" id="newQuestInput" class="sys-input" placeholder="Ex: Treino de Força">
                
                <label class="input-label">ATRIBUTOS ASSOCIADOS</label>
                <div class="attr-grid">
                    <div class="attr-btn" data-type="STR" onclick="toggleAttr('STR')">FOR</div>
                    <div class="attr-btn" data-type="AGI" onclick="toggleAttr('AGI')">AGI</div>
                    <div class="attr-btn" data-type="VIT" onclick="toggleAttr('VIT')">VIT</div>
                    <div class="attr-btn" data-type="INT" onclick="toggleAttr('INT')">INT</div>
                    <div class="attr-btn" data-type="SEN" onclick="toggleAttr('SEN')">SEN</div>
                </div>

                <label class="input-label">XP</label>
                <select id="newQuestXP" class="sys-select">
                    <option value="50">50 XP (Muito Fácil)</option>
                    <option value="100">100 XP (Fácil)</option>
                    <option value="200">200 XP (Médio)</option>
                    <option value="300">300 XP (Bom)</option>
                    <option value="500">500 XP (Difícil)</option>
                    <option value="1000">1.000 XP (Muito Difícil)</option>
                    <option value="2500">2.500 XP (Boss Semanal)</option>
                </select>

                <label class="input-label">RECORRÊNCIA</label>
                <div class="recurrence-selector">
                    <button class="rec-btn selected-none" onclick="setRecurrence('none')" id="btn-none">ÚNICA</button>
                    <button class="rec-btn" onclick="setRecurrence('flexible')" id="btn-flex">RECORRENTE</button>
                    <button class="rec-btn" onclick="setRecurrence('mandatory')" id="btn-mand">OBRIGATÓRIA</button>
                </div>
                <input type="hidden" id="recurrenceValue" value="none">

                <button class="btn-add" onclick="addNewQuest()">ADICIONAR AO SISTEMA</button>
            </div>
            
            <div class="section-title">GERENCIAR LISTA</div>
            <div id="editor-quest-list"></div>
            
            <button class="btn-reset" onclick="hardReset()">⚠ RESETAR TUDO</button>
        </div>

    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('home')">STATUS</button>
        <button class="nav-btn" onclick="switchTab('library')">GRIMÓRIO</button>
        <button class="nav-btn" onclick="switchTab('editor')">EDITOR</button>
    </div>

    <div class="popup-overlay" id="rewardPopup" onclick="closePopup()">
        <div class="popup-box">
            <div style="color:var(--theme-color); font-size:24px; font-weight:bold;">MISSÃO CUMPRIDA</div>
            <div style="font-size:14px; color:#aaa; margin-bottom:10px;">RECOMPENSA OBTIDA</div>
            <div class="popup-stat" id="popupStatValue"></div>
            <div class="popup-xp" id="popupXpValue"></div>
            <div style="margin-top:20px; font-size:12px; color:#666;">(Toque para continuar)</div>
        </div>
    </div>

    <div class="popup-overlay" id="levelUpPopup" onclick="closeLevelPopup()">
        <div class="levelup-box">
            <div style="color: var(--gold-color); font-size: 24px; font-weight: bold; letter-spacing: 2px;">LEVEL UP!</div>
            <div style="color: #ccc; font-size: 14px;">LIMITES SUPERADOS</div>
            <div class="levelup-num" id="newLevelDisplay">1</div>
            <div style="margin-top:20px; font-size:12px; color:#fff; border:1px solid #555; padding:5px; display:inline-block; border-radius:5px;">CONTINUAR</div>
        </div>
    </div>

    <div class="popup-overlay" id="bookPopup">
        <div class="popup-box">
            <div id="bookDetailContent" class="book-detail-content"></div>
            <button class="btn-close" onclick="closeBookPopup()" style="margin-top:20px;">FECHAR</button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDnTgThcU_lVdXASbg9ufMeUEE_x2uaYfQ",
      authDomain: "sontak-arise.firebaseapp.com",
      databaseURL: "https://sontak-arise-default-rtdb.firebaseio.com",
      projectId: "sontak-arise",
      storageBucket: "sontak-arise.firebasestorage.app",
      messagingSenderId: "165204128476",
      appId: "1:165204128476:web:8ed10f60587bcecad47a19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const userRef = ref(db, 'usuarios/vitor');

    // --- VARIÁVEIS GLOBAIS ---
    let playerData = { level: 1, xp: 0, stats: [0, 0, 0, 0, 0], quests: [], library: [] };
    let chartInstance = null;
    const MAX_XP = 2500; 
    const XP_FACTOR = 100; 
    let selectedAttrs = [];
    const bgMusic = document.getElementById("bgMusic");
    let isPlaying = false;

    // --- MÚSICA ---
    window.toggleMusic = function() {
        const btn = document.getElementById('btnPlayPause');
        if (isPlaying) { bgMusic.pause(); btn.innerText = "▶ PLAY"; btn.style.color = "#888"; }
        else { bgMusic.play(); btn.innerText = "❚❚ PAUSE"; btn.style.color = "var(--flex-color)"; }
        isPlaying = !isPlaying;
    }
    window.changeVolume = function(delta) {
        let newVol = bgMusic.volume + delta;
        if(newVol > 1) newVol = 1; if(newVol < 0) newVol = 0;
        bgMusic.volume = newVol;
    }

    // --- LOGIN ---
    let pass = ""; const REAL_PASS = "010118";
    window.pressKey = function(n) { if(pass.length < 6) { pass += n; updatePass(); } }
    window.clearPass = function() { pass = ""; updatePass(); }
    window.checkPass = function() {
        if(pass === REAL_PASS) {
            document.getElementById('login-overlay').style.display='none';
            const boot = document.getElementById('boot-screen');
            boot.style.display='flex';
            
            // Tenta tocar música
            bgMusic.volume = 0.5;
            bgMusic.play().then(()=>{ isPlaying=true; document.getElementById('btnPlayPause').innerText="❚❚ PAUSE"; }).catch(()=>{});

            setTimeout(() => {
                boot.classList.add('fade-out-screen');
                document.getElementById('mainApp').style.display='flex';
                initApp();
                setTimeout(() => boot.style.display='none', 800);
            }, 3000);
        } else {
            const d = document.getElementById('passDisplay');
            d.style.borderColor='var(--danger)'; d.style.color='var(--danger)';
            setTimeout(() => { pass=""; updatePass(); d.style.borderColor='var(--theme-color)'; d.style.color='white'; }, 400);
        }
    }
    function updatePass() {
        let v = ""; for(let i=0; i<6; i++) { v += (i < pass.length) ? "● " : "  "; }
        document.getElementById('passDisplay').innerText = v;
    }

    // --- INICIALIZAÇÃO ---
    function initApp() {
        initChart();
        onValue(userRef, (snap) => {
            const val = snap.val();
            if(val) {
                playerData = val;
                if(!playerData.quests) playerData.quests = [];
                if(!playerData.library) playerData.library = [];
                if(!playerData.stats) playerData.stats = [0,0,0,0,0];
            } else { saveData(); }
            updateUI();
        });
    }

    // --- LÓGICA DE DADOS & UI ---
    function updateUI() {
        // Header
        const xpReq = Math.min(playerData.level * 100, MAX_XP);
        document.getElementById('displayLevel').innerText = playerData.level;
        document.getElementById('xpText').innerText = `${playerData.xp} / ${xpReq}`;
        document.getElementById('xpBar').style.width = Math.min((playerData.xp / xpReq)*100, 100) + "%";

        // Stats & Chart
        const labels = ['STR','AGI','VIT','INT','SEN'];
        const visualData = [];
        playerData.stats.forEach((xp, i) => {
            const lvl = Math.floor(Math.sqrt(xp / XP_FACTOR));
            document.getElementById(`val-${labels[i]}`).innerText = lvl;
            let percent = 0;
            if(lvl <= 10) percent = lvl * 5;
            else if(lvl <= 20) percent = 50 + (lvl-10);
            else percent = 60 + ((lvl-20)*0.5);
            visualData.push(Math.min(percent, 100));
        });
        chartInstance.data.datasets[0].data = visualData;
        chartInstance.update();

        // Listas
        renderQuests();
        renderLibrary();
    }

    // --- RENDERIZADORES ---
    function renderQuests() {
        const homeList = document.getElementById('home-quest-list');
        const editorList = document.getElementById('editor-quest-list');
        homeList.innerHTML = ""; editorList.innerHTML = "";

        playerData.quests.forEach((q, i) => {
            // Home (Só pendentes e não deletadas)
            if(!q.done) {
                let border = "3px solid #444";
                if(q.recurrence === 'flexible') border = "3px solid var(--flex-color)";
                if(q.recurrence === 'mandatory') border = "3px solid var(--mand-color)";
                
                homeList.innerHTML += `
                <div class="quest-card" style="border-left:${border}">
                    <div class="checkbox" onclick="completeQuest(${i})"></div>
                    <div class="task-text">${q.text}</div>
                    <div class="tags-container">
                        <div class="xp-tag">+${q.xpValue} XP</div>
                    </div>
                </div>`;
            }
            // Editor
            editorList.innerHTML += `
            <div class="quest-card">
                <div class="task-text" style="color:#aaa">${q.text} (${q.xpValue} XP)</div>
                <div class="action-container">
                    <button class="action-btn" style="color:var(--danger)" onclick="deleteQuest(${i})">✖</button>
                </div>
            </div>`;
        });
        if(homeList.innerHTML === "") homeList.innerHTML = "<div style='text-align:center; color:#555; margin-top:20px;'>NENHUMA MISSÃO ATIVA</div>";
    }

    function renderLibrary() {
        const grid = document.getElementById('library-grid');
        grid.innerHTML = "";
        playerData.library.forEach((book, i) => {
            let cover = book.cover || 'https://via.placeholder.com/100x150/222/888?text=Sem+Capa';
            grid.innerHTML += `
            <div class="book-card" onclick="showBookDetails(${i})">
                ${book.cover ? `<img src="${book.cover}" class="book-cover">` : `<div class="book-placeholder">${book.title}</div>`}
                ${book.cover ? '' : ''}
            </div>`;
        });
    }

    // --- FUNÇÕES DE MISSÃO ---
    window.completeQuest = function(i) {
        const q = playerData.quests[i];
        q.done = true;
        if(q.recurrence !== 'none') q.lastDoneDate = new Date().toDateString();
        
        playerData.xp += q.xpValue;
        const xpShare = Math.floor(q.xpValue / q.types.length);
        q.types.forEach(t => {
            const idx = ['STR','AGI','VIT','INT','SEN'].indexOf(t);
            if(idx > -1) playerData.stats[idx] += xpShare;
        });
        
        checkLevelUp();
        saveData();
        showReward("XP Adicionado aos Atributos", q.xpValue);
    }

    window.addNewQuest = function() {
        const txt = document.getElementById('newQuestInput').value;
        const xp = parseInt(document.getElementById('newQuestXP').value);
        const rec = document.getElementById('recurrenceValue').value;
        
        if(txt && selectedAttrs.length > 0) {
            playerData.quests.push({ text: txt, types: [...selectedAttrs], xpValue: xp, recurrence: rec, done: false });
            selectedAttrs = []; document.querySelectorAll('.attr-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('newQuestInput').value = "";
            saveData();
            showSuccess();
        } else { alert("Preencha nome e atributos!"); }
    }

    window.deleteQuest = function(i) { if(confirm("Deletar?")) { playerData.quests.splice(i,1); saveData(); } }

    window.toggleAttr = function(t) {
        const btn = document.querySelector(`.attr-btn[data-type="${t}"]`);
        if(selectedAttrs.includes(t)) { selectedAttrs = selectedAttrs.filter(x=>x!==t); btn.classList.remove('selected'); }
        else { selectedAttrs.push(t); btn.classList.add('selected'); }
    }
    
    window.setRecurrence = function(t) {
        document.getElementById('recurrenceValue').value = t;
        document.querySelectorAll('.rec-btn').forEach(b => {
            b.className = 'rec-btn';
            if(b.innerText.includes(t.toUpperCase()) || (t==='none' && b.innerText==='ÚNICA')) b.classList.add('selected-'+t);
        });
    }

    // --- FUNÇÕES DE BIBLIOTECA (GOOGLE API) ---
    window.fetchAndAddBook = function() {
        const isbn = document.getElementById('bookIsbn').value.trim();
        const manualTitle = document.getElementById('bookTitleInput').value.trim();
        const xpVal = parseInt(document.getElementById('bookXp').value);
        const btn = document.getElementById('btnAddBook');

        if(!isbn && !manualTitle) { alert("Digite ISBN ou Título!"); return; }

        btn.innerText = "BUSCANDO...";

        if(isbn) {
            // Busca na Google Books API (langRestrict=pt)
            fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&langRestrict=pt`)
            .then(r => r.json())
            .then(data => {
                let bookData = {
                    title: manualTitle || "Livro Sem Título",
                    cover: "",
                    desc: "Sinopse não disponível.",
                    xpValue: xpVal
                };

                if(data.items && data.items.length > 0) {
                    const info = data.items[0].volumeInfo;
                    bookData.title = info.title;
                    if(info.imageLinks) bookData.cover = info.imageLinks.thumbnail.replace('http:', 'https:');
                    if(info.description) bookData.desc = info.description;
                } else if(manualTitle) {
                    alert("ISBN não encontrado, usando dados manuais.");
                } else {
                    alert("Livro não encontrado.");
                    btn.innerText = "BUSCAR E REGISTRAR";
                    return;
                }
                
                saveBook(bookData);
                btn.innerText = "BUSCAR E REGISTRAR";
            })
            .catch(() => { alert("Erro de conexão."); btn.innerText = "BUSCAR E REGISTRAR"; });
        } else {
            saveBook({ title: manualTitle, cover: "", desc: "Adicionado manualmente.", xpValue: xpVal });
            btn.innerText = "BUSCAR E REGISTRAR";
        }
    }

    function saveBook(book) {
        playerData.library.push(book);
        
        if(book.xpValue > 0) {
            playerData.xp += book.xpValue;
            const share = Math.floor(book.xpValue / 2);
            playerData.stats[3] += share; // INT
            playerData.stats[4] += share; // SEN
            checkLevelUp();
            showReward(`+${share} INT / +${share} SEN`, book.xpValue);
        } else {
            showSuccess();
        }

        document.getElementById('bookIsbn').value = "";
        document.getElementById('bookTitleInput').value = "";
        saveData();
    }

    window.showBookDetails = function(i) {
        const b = playerData.library[i];
        const content = document.getElementById('bookDetailContent');
        const cover = b.cover || 'https://via.placeholder.com/150x220/333/888?text=Sem+Capa';
        
        content.innerHTML = `
            <div style="text-align:center;">
                <img src="${cover}" class="book-expanded-cover">
                <h3 style="color:var(--theme-color); margin:10px 0;">${b.title}</h3>
                <div class="book-xp-badge">XP: ${b.xpValue}</div>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#888;">SINOPSE:</div>
            <div class="book-synopsis">${b.desc}</div>
            <button class="btn-delete" onclick="removeBook(${i})">REMOVER DO ACERVO</button>
        `;
        document.getElementById('bookPopup').style.display = 'flex';
    }

    window.removeBook = function(i) {
        if(confirm("Remover livro? (XP permanece)")) {
            playerData.library.splice(i, 1);
            saveData();
            closeBookPopup();
        }
    }

    window.closeBookPopup = function() { document.getElementById('bookPopup').style.display = 'none'; }

    // --- UTILITÁRIOS ---
    function checkLevelUp() {
        let req = Math.min(playerData.level * 100, MAX_XP);
        while(playerData.xp >= req) {
            playerData.xp -= req;
            playerData.level++;
            req = Math.min(playerData.level * 100, MAX_XP);
            document.getElementById('newLevelDisplay').innerText = playerData.level;
            document.getElementById('levelUpPopup').style.display = 'flex';
        }
    }

    window.saveData = function() { set(userRef, playerData); updateUI(); }
    window.showSuccess = function() { const p = document.getElementById('successPopup'); p.style.display='flex'; setTimeout(()=>p.style.display='none', 1500); }
    window.showReward = function(txt, xp) { document.getElementById('popupStatValue').innerHTML=txt; document.getElementById('popupXpValue').innerText=`+${xp} XP`; document.getElementById('rewardPopup').style.display='flex'; }
    window.closePopup = function() { document.getElementById('rewardPopup').style.display='none'; }
    window.closeLevelPopup = function() { document.getElementById('levelUpPopup').style.display='none'; }
    
    window.switchTab = function(t) {
        document.querySelectorAll('.tab-view').forEach(e => e.style.display='none');
        document.getElementById('tab-'+t).style.display='block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(t==='home' && chartInstance) chartInstance.resize();
    }

    window.hardReset = function() {
        if(prompt("SENHA ADM:") === "Yasuo010118*") {
            set(userRef, { level:1, xp:0, stats:[0,0,0,0,0], quests:[], library:[] });
            location.reload();
        }
    }

    // EXPOR PARA HTML
    window.fetchAndAddBook = window.fetchAndAddBook;
    window.showBookDetails = window.showBookDetails;
    window.removeBook = window.removeBook;
    window.closeBookPopup = window.closeBookPopup;
    window.changeVolume = window.changeVolume;
    window.completeQuest = window.completeQuest;
    window.deleteQuest = window.deleteQuest;
</script>

</body>
</html>
